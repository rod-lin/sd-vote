<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Pragma" content="no-cache">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
		
		<title>星元头像投票</title>

		<link rel="stylesheet" href="font/fontawesome/import.css">
		<link rel="stylesheet" href="font/alegreya/import.css">
		<link rel="stylesheet" href="font/chfont/import.css">
		<link rel="stylesheet" href="font/ubuntu/import.css">
		<link rel="stylesheet" href="css/vote.css">

		<script src="js/jquery.js"></script>
		<script src="http://static.geetest.com/static/tools/gt.js"></script>
	</head>

	<body style="opacity: 0;">
		<div id="sv-container">
			<div id="sv-cover">
				<div id="sv-qtitle" class="sv-noselect">
					<span style="font-size: 140%;">星元</span><br>
					<span>头像投票</span><br>
					<span style="font-size: 50%;">狂戳继续</span>
				</div>
			</div>

			<div id="sv-main">
				<div id="sv-showcase" class="sv-noselect">
					<div style="padding-bottom: 1em;">
						<div id="sv-tip" style="font-family: Alegreya;">
							<!--span>长按选项查看大图<br>点击大勾勾提交</span-->
							<span class="sv-vcenter sv-help-btn">
								<span id="sv-help-btn" class="fa fa-question-circle"></span>
							</span>
							<span id="sv-about-btn">
								StarDollar
							</span>
						</div>
						
						<!--div class="sv-selebox">
							<div class="sv-thumb sv-img"></div>
							<div class="sv-namecard">David!</div>
							<div class="sv-selebox-checked-layer"><span class="fa fa-check sv-selebox-check sv-vcenter"></span></div>
						</div>

						<div class="sv-selebox">
							<div class="sv-thumb sv-img"></div>
							<div class="sv-namecard">Rod!</div>
							<div class="sv-selebox-checked-layer"><span class="fa fa-check sv-selebox-check sv-vcenter"></span></div>
						</div-->

						<div id="sv-tag-1" style="display: none;"></div>

						<div class="sv-selebox sv-selebox-btn">
							<div id="sv-addbtn" class="sv-addbtn">
								<span id="sv-addsymb" class="fa fa-plus"></span>
							</div>
							<div id="sv-addbtn-tinyform" style="display: none; opacity: 0;">
								<div id="sv-addbtn-inputbox" class="sv-addbtn-inputbox">
									<input id="sv-addbtn-nameinput" class="sv-addbtn-nameinput" placeholder="name"><br>
									<div class="sv-split"></div><br>
									<textarea id="sv-addbtn-descrinput" class="sv-addbtn-descrinput" placeholder="description"></textarea>
								</div>
								<div id="sv-addbtn-photo">
									<span id="sv-addbtn-photo-symb" class="fa fa-photo sv-vcenter" style="pointer-events: none;"></span>
								</div>
								<div id="sv-addbtn-submit">
									<span id="sv-addbtn-submit-symb" class="fa fa-check sv-vcenter" style="pointer-events: none;"></span>
								</div>
							</div>
						</div>

						<!--div class="sv-selebox sv-selebox-btn">
							<div id="sv-addbtn" class="sv-addbtn">
								<span id="sv-addsymb" class="fa fa-plus"></span>
							</div>
						</div-->

						<div class="sv-selebox sv-selebox-btn">
							<div id="sv-submbtn" class="sv-submbtn">
								<span id="sv-submsymb" class="fa fa-check"></span>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div id="sv-zoomin-box" style="display: none; opacity: 0;">
				<div id="sv-zoomin-cont" class="sv-vcenter">
					<img id="sv-zoomin-img" src="img/tmp1.jpg" /><br>
					<div id="sv-zoomin-descr" class="sv-noselect">Hello</div>
				</div>
				<!-- prevent user from selecting the picture before it's really shown -->
				<div id="sv-zoomin-alayer"></div>
			</div>

			<div id="sv-load">
				<span class="fa fa-rocket fa-spin sv-vcenter" style="font-size: 5em; margin-bottom: 1em;"></span>
			</div>

			<form id="sv-newicon-form" action="/vote/reg" method="post"
				  style="display: none;" enctype="multipart/form-data">
				<input id="sv-newicon-form-photo" type="file" name="photo">
				<input id="sv-newicon-form-name" type="text" name="name">
				<input id="sv-newicon-form-descr" type="text" name="descr">
			</form>

			<div id="sv-msgbox" class="sv-noselect" style="top: -100%;">
				<div id="sv-msg" class="sv-noselect sv-vcenter"></div>
			</div>

			<div id="sv-captcha-box" style="top: -100%;">
				<div id="sv-captcha" class="sv-noselect"></div>
			</div>
		</div>

		<div id="sv-prompt" style="display: none; font-family: tekai, mini-jiankai;">
			不能投两次啊每人最多添加一个选项额图太大了你还没有选呢最多选三个哦服务器炸了!额没有名字没有描述没有图片啊啊啊谢谢
			长按选项查看大图点击大勾勾帮助点击选项可选择长按可查看大图点击最后的大勾勾提交点击加号可增加选项
			星元是一款专为中学生设计的货币更多介绍
			请勿上传涉及反动，淫秽色情或版权问题的图片或文字
		</div>

		<script>
			function _jump(url) {
				$("body").css("opacity", "0");
				setTimeout(function () {
					window.location = url;
				}, 300);
				return;
			}

			Array.prototype.choose = function () {
				return this[Math.floor(Math.random() * this.length)];
			};

			(function ($) {
				var color_box = [ "#1ABC9C", "#2ECC71", "#3498DB", "#9B59B6", "#E67E22", "#E74C3C" ];

				function _setVCenter(pr, e) {
					e.css("top", ((pr.height() - e.outerHeight(true)) / 2) + "px");
					return;
				}

				function _updatePos() {
					_setVCenter($("#sv-main"), $("#sv-qtitle"));
					_setVCenter($("#sv-addbtn"), $("#sv-addsymb"));
					_setVCenter($("#sv-submbtn"), $("#sv-submsymb"));

					var e = $(".sv-vcenter");
					var i;

					for (i = 0; i < e.length; i++) {
						_setVCenter($(e[i]).parent(), $(e[i]));
					}

					return;
				}

				function _showImage(url, descr)
				{
					if (descr.length > 24) {
						descr = descr.substr(0, 24) + "...";
					}

					if (descr.length == 0) {
						descr = "(no description)";
					}

					$("#sv-zoomin-box").css("display", "");
					$("#sv-zoomin-img").attr("src", url);
					$("#sv-zoomin-descr").html(descr);
					$("#sv-zoomin-img").css("max-height", $("#sv-zoomin-box").height() * 0.7 + "px");

					_updatePos();

					setTimeout(function () {
						$("#sv-zoomin-box").css("opacity", "1");
						setTimeout(function () {
							$("#sv-zoomin-alayer").css("display", "none");
						}, 300);
					}, 300);

					return;
				}

				function _hideImage() {
					$("#sv-zoomin-alayer").css("display", "");
					$("#sv-zoomin-box").css("opacity", "0");
					setTimeout(function () {
						$("#sv-zoomin-box").css("display", "none");
					}, 300);
				}

				function _showNewIcon() {
					_msg("<span style='font-size: 120%;'>请勿</span><br><span style='font-size: 70%;'>上传涉及反动，淫秽色情或版权问题的图片或文字</span>", 0, null, function () {
							$("#sv-addbtn-tinyform").css("display", "");
							$("#sv-addbtn").css("opacity", "0");

							setTimeout(function () {
								$("#sv-addbtn-tinyform").css("opacity", "1");
							}, 300);

							_updatePos();
						});

					return;
				}

				function _hideNewIcon() {
					$("#sv-addbtn-tinyform").css("opacity", "0");
					$("#sv-addbtn").css("opacity", "1");
					setTimeout(function () {
						$("#sv-addbtn-tinyform").css("display", "none");
						_updatePos();
					}, 300);
					return;
				}

				function _showLoad() {
					$("#sv-load").css("display", "");
					$("#sv-load").css("opacity", "1");
					_updatePos();
					return;
				}

				function _hideLoad() {
					$("#sv-load").css("opacity", "0");
					setTimeout(function () {
						$("#sv-load").css("display", "none");
					}, 300);
					return;
				}

				function _showThanks() {
					_msg(' \
						<span class="fa fa-check" style="font-size: 2em;"></span><br> \
						<span style="font-size: 1em; font-family: tekai;">谢谢</span> \
					', 0, "#2ECC71");
					return;
				}

				function _openDetail(e) {
					var candid = parseInt($(e).find("#sv-tag-candid").html());

					if (isNaN(candid)) return;

					_showImage("/upload/" + _allcand[candid].photo, _allcand[candid].descr);

					return;
				}

				function _closeDetail() {
					_hideImage();

					return;
				}

				function _exitCover() {
					$.ajax({ url: "/vote/incview", type: "GET" });
					$("#sv-cover").css("left", "-100%");

					return;
				}

				function _openAbout() {
					_msg("<span style='font-size: 120%;'>星元</span><br><span style='font-size: 85%;' onclick='_jump(\"/intro\")'>一款专为中学生设计的货币<br><br><span class='fa fa-rocket' style='font-size: 170%; cursor: pointer;'></span></span>", 0);
					return;
				}

				function _openHelp() {
					_msg("帮助<br><span style='font-family: mini-jiankai; font-size: 70%;'><br>点击选项可选择<br>长按可查看大图<br>点击加号可增加选项<br>点击最后的大勾勾提交</span>", 0);
					return;
				}

				var _msg_show = false;
				var _msg_hide_proc = null;
				var _msg_cb = null;
				var _msg_hide = function () {
					if (_msg_show) {
						_msg_show = false;

						if (_msg_hide_proc) {
							clearTimeout(_msg_hide_proc);
							_msg_hide_proc = null;
						}

						$("#sv-msgbox").css("top", "-100%");

						if (_msg_cb) {
							setTimeout(_msg_cb, 1000);
						}
					}
				};

				function _msg(msg, timeout, color, cb) {
					// alert(msg);

					_msg_show = true;

					if (msg) {
						$("#sv-msg").html(msg);
					}

					$("#sv-msgbox").css("top", "0");
					$("#sv-msgbox").css("background", color || color_box.choose());

					_updatePos();

					_msg_cb = cb;

					if (timeout != 0) {
						_msg_hide_proc = setTimeout(_msg_hide, timeout || 3000);
					}

					return;
				}

				function _showCaptcha() {
					$("#sv-captcha-box").css("top", "0");
				}

				function _hideCaptcha() {
					$("#sv-captcha-box").css("top", "-100%");
				}

				function _check() {
					$(this).toggleClass("sv-selebox-checked");
					var candid = parseInt($(this).find("#sv-tag-candid").html());
					
					if (isNaN(candid)) {
						_msg("that's... not a candidate");
						return;
					}

					_allcand[candid].checked = $(this).hasClass("sv-selebox-checked");

					return;
				}

				function _captchaValidate(dat, cb)
				{
					var data = JSON.parse(dat);

					if (!data.suc) {
						cb(dat);
						return;
					}

					if (data.dat == false) {
						// no captcha
						cb(dat);
						return;
					}

					dat = data.dat;

					initGeetest({
						gt: dat.gt,
						challenge: dat.challenge,
						product: "popup"
					}, function (captcha) {
						captcha.onSuccess(function () {
							var query = captcha.getValidate();

							$("#sv-captcha").html("");
							_hideCaptcha(captcha);

							$.ajax({
								url: "/valid",
								type: "GET",
								data: {
									ochallenge: dat.challenge,
									challenge: query.geetest_challenge,
									validate: query.geetest_validate,
									seccode: query.geetest_seccode
								},
								success: function (dat) {
									cb(dat);
								}
							});
						});

						captcha.appendTo("#sv-captcha");
						// captcha.zoom("70%");
						_showCaptcha(captcha);
					});

					return;
				}

				function _longpress(e) {
					_openDetail(e);
				}

				var _prompt = [
					"不能投两次啊",
					"每人最多添加一个选项额",
					"图太大了orz"
				];

				function _submit() {
					var i;
					var selected = [];

					for (i = 0; i < _allcand.length; i++) {
						if (_allcand[i].checked)
							selected.push(_allcand[i].id.toString());
					}

					if (!selected.length) {
						_msg("你还没有选呢");
						return;
					}

					if (selected.length > 3) {
						_msg("最多选三个哦");
						return;
					}

					var _show = function () {
						$("#sv-submsymb").removeClass("fa-check");
						$("#sv-submsymb").addClass("fa-cog");
						$("#sv-submsymb").addClass("fa-spin");
					};

					var _hide = function () {
						$("#sv-submsymb").addClass("fa-check");
						$("#sv-submsymb").removeClass("fa-cog");
						$("#sv-submsymb").removeClass("fa-spin");
					};

					_show();

					$.ajax({
						url: "/vote/poll",
						type: "GET",
						data: {
							cand: selected.join("|")
						},

						success: function (dat) {
							_captchaValidate(dat, function (dat) {
								var dat = JSON.parse(dat);

								setTimeout(function () {
									if (!dat.suc) {
										if (dat.prompt != undefined) {
											_msg(_prompt[dat.prompt]);
										} else {
											_msg(dat.msg);
										}
									} else {
										_showThanks();

										setTimeout(function () {
											_jump(window.location);
										}, 2000);
									}

									_hide();
								}, 500);

								return;
							});
						},

						error: function () {
							setTimeout(function () {
								_msg("服务器炸了!");
								_hide();
							}, 500);
							return;
						}
					});

					return;
				}

				function _addicon() {
					_showNewIcon();
				}

				function _uploadIcon() {
					$("#sv-newicon-form-photo").click();
					return;
				}

				function _submitNewIcon() {
					var name = $("#sv-addbtn-nameinput").val();
					var descr = $("#sv-addbtn-descrinput").val();

					if (!name || !name.length) {
						_msg("额没有名字");
						return;
					}

					if (!descr || !descr.length) {
						_msg("没有描述orz");
						return;
					}

					if (!$("#sv-newicon-form-photo").val()) {
						_msg("没有图片啊啊啊");
						return;
					}

					$("#sv-newicon-form-name").val(name);
					$("#sv-newicon-form-descr").val(descr);

					var _load_start = function () {
						/*
						$("#sv-addbtn-inputbox").css("width", "0");
						$("#sv-addbtn-submit").css("width", "100%");
						$("#sv-addbtn-submit").css("left", "0");
						$("#sv-addbtn-submit").css("height", "100%");
						*/

						$("#sv-addbtn-submit-symb").addClass("fa-cog");
						$("#sv-addbtn-submit-symb").addClass("fa-spin");
						$("#sv-addbtn-submit-symb").removeClass("fa-check");

						$("#sv-addbtn-submit").unbind("click");
					};

					var _load_end = function () {
						/*
						$("#sv-addbtn-inputbox").css("width", "80%");
						$("#sv-addbtn-submit").css("width", "20%");
						$("#sv-addbtn-submit").css("left", "80%");
						$("#sv-addbtn-submit").css("height", "60%");
						*/

						$("#sv-addbtn-submit-symb").removeClass("fa-cog");
						$("#sv-addbtn-submit-symb").removeClass("fa-spin");
						$("#sv-addbtn-submit-symb").addClass("fa-check");

						$("#sv-addbtn-submit").click(_submitNewIcon);
					};

					_load_start();

					setTimeout(function () {
						var form = $("#sv-newicon-form")[0];
					
						$.ajax({
							url: "/vote/reg",
							type: "POST",
							data: new FormData(form),
							processData: false,
							contentType: false,
							success: function (dat) {
								_captchaValidate(dat, function (dat) {
									var dat = JSON.parse(dat);

									if (!dat.suc) {
										if (dat.prompt != undefined) {
											_msg(_prompt[dat.prompt]);
										} else {
											_msg(dat.msg);
										}

										setTimeout(function () {
											_load_end();
											_hideNewIcon();
										}, 1000);

										return;
									}

									setTimeout(function () {
										_showThanks();
										setTimeout(_load_end, 1000);

										setTimeout(function () {
											_jump(window.location);
										}, 2000);
									}, 500);
								});
							},

							error: function () {
								_msg("服务器炸了!");
								setTimeout(function () {
									_load_end();
									_hideNewIcon();
								}, 1000);

								return;
							}
						});
					}, 1000);

					return;
				}

				var _allcand = null;

				function truncdig(num, n) {
					var k = Math.pow(10, n);
					return Math.round(num * k) / k;
				}

				function _sync() {
					var resp = $.ajax({ url: "/vote/get", type: "GET", async: false }).responseText;
					var resp = JSON.parse(resp);

					if (!resp.suc) {
						_msg("server busy");
						return;
					}

					var allcand = resp.dat;
					var i = 0, j, k, tmp;
					var tag = $("#sv-tag-1");

					for (i = 0; i < (allcand.length / 2); i++) {
						j = Math.floor(Math.random() * allcand.length);
						k = Math.floor(Math.random() * allcand.length);
						tmp = allcand[j];
						allcand[j] = allcand[k];
						allcand[k] = tmp;
					}

					var sum = 0;

					for (i = 0; i < allcand.length; i++) {
						sum += allcand[i].poll;
					}

					allcand.sort(function (a, b) {
						return b.poll - a.poll
					});

					for (i = 0; i < allcand.length; i++) {
						var tmp =
						'<div class="sv-selebox sv-noselect"> \
							<div class="sv-thumb sv-img sv-noselect" style="background-image: url(\'/upload/' + allcand[i].photo + '\');"></div> \
							<div class="sv-namecard">' +
								(i < 3 ? "<span class='fa fa-star sv-namecard-star sv-namecard-star-" + (i + 1) + "'></span>" : "") + 
								allcand[i].name + ' (' + allcand[i].poll + (allcand[i].poll > 1 ? " votes, " : " vote, ") + (sum ? truncdig(allcand[i].poll / sum * 100, 2) : "0") + '%)' +
							'</div> \
							<div class="sv-selebox-checked-layer"><span class="fa fa-check sv-selebox-check sv-vcenter"></span></div> \
							<div id="sv-tag-candid" style="display: none;">' + i + '</div> \
							<div class="sv-selebox-alayer"></div> \
						</div>';

						// TODO: !!inject
						tag.before(tmp);
					}

					_allcand = allcand;

					_bondbox();
					_updatePos();
				}

				function _bondbox() {
					$(".sv-selebox:not(.sv-selebox-btn)").click(_check);
					$("#sv-submbtn").click(_submit);
					$("#sv-addbtn").click(_addicon);
					
					$("#sv-zoomin-box").click(_hideImage);

					// $("#sv-newicon-back").click(_hideNewIcon);
					// $("#sv-newicon-img").click(_uploadIcon);
					// $("#sv-newicon-submit").click(_submitNewIcon);
					
					$("#sv-addbtn-submit").click(_submitNewIcon);
					$("#sv-addbtn-photo").click(_uploadIcon);

					$("#sv-about-btn").click(_openAbout);
					$("#sv-help-btn").click(_openHelp);

					$("#sv-msgbox").click(_msg_hide);

					var timer = null;
					var _start = function () {
						var e = $(this).parent();
						timer = setTimeout(function () {
							_longpress(e);
						}, 300);
					};

					var _stop = function () {
						if (timer) {
							clearTimeout(timer);
						}
					};

					$(".sv-selebox-alayer").mousedown(_start);
					$(".sv-selebox-alayer").on("touchstart", _start);

					$(".sv-selebox-alayer").mouseup(_stop);
					$(".sv-selebox-alayer").mouseout(_stop);
					$(".sv-selebox-alayer").on("touchend", _stop);
					$(".sv-selebox-alayer").on("touchmove", _stop);

					return;
				}

				window.onload = function () {
					$("body").css("opacity", 1);

					_hideLoad();

					_openHelp();

					$("#sv-cover").css("background", color_box.choose());
					$("#sv-cover").click(_exitCover);

					_updatePos();

					_sync();

					return;
				};

				window.onresize = _updatePos;
				_updatePos();
			})(jQuery);

		</script>
	</body>
</html>
